# Setting up Drizzle ORM with Supabase

Yes! You can absolutely use Drizzle ORM with Supabase, and it's highly recommended for better type safety and developer experience.

## Why use Drizzle with Supabase?

- **Type Safety**: Full TypeScript support with inference
- **Better DX**: Intuitive query builder
- **Performance**: Optimized queries
- **Schema Management**: Version controlled migrations
- **Flexibility**: Raw SQL when needed

## Setup Steps

### 1. Environment Configuration

Add your database connection string to `.env`:

```bash
# Get this from Supabase Dashboard -> Settings -> Database -> Connection String
DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres

# Keep your existing Supabase config for auth
SUPABASE_URL=your-supabase-url
SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
```

### 2. Database Connection Setup

Create `app/lib/database/drizzle.ts`:

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from './schema'

// PostgreSQL connection
const sql = postgres(process.env.DATABASE_URL!, { max: 1 })

// Drizzle instance with schema
export const db = drizzle(sql, { schema })

// Export everything
export * from './schema'
```

### 3. Schema Definition (already done!)

Your existing `app/lib/database/schema.ts` is perfect! It defines:
- Tables with proper relationships
- TypeScript types
- Indexes for performance

### 4. Migration Management

```bash
# Generate migrations from schema changes
npm run db:generate

# Push changes to database
npm run db:push

# Open Drizzle Studio
npm run db:studio
```

### 5. Usage Examples

#### Query with Relations:
```typescript
import { db } from '~/lib/database/drizzle'
import { groups, goals, users } from '~/lib/database/schema'
import { eq } from 'drizzle-orm'

// Get group with teacher and goals
const groupWithData = await db
  .select({
    group: groups,
    teacher: users,
    goals: goals
  })
  .from(groups)
  .leftJoin(users, eq(groups.teacherId, users.id))
  .leftJoin(goals, eq(goals.groupId, groups.id))
  .where(eq(groups.id, groupId))
```

#### Insert with Validation:
```typescript
const newGroup = await db
  .insert(groups)
  .values({
    name: 'New Group',
    description: 'Description',
    teacherId: userId,
    qrCodeToken: generateToken()
  })
  .returning()
```

#### Complex Queries:
```typescript
import { sql } from 'drizzle-orm'

// Get completion statistics
const stats = await db
  .select({
    goalId: goalProgress.goalId,
    totalParticipants: sql<number>`count(distinct ${goalProgress.participantId})`,
    completedCount: sql<number>`count(case when ${goalProgress.isCompleted} then 1 end)`
  })
  .from(goalProgress)
  .where(eq(goalProgress.goalId, goalId))
  .groupBy(goalProgress.goalId)
```

## Migration Strategy

1. **Keep Supabase for Auth**: Continue using Supabase Auth (it's excellent)
2. **Use Drizzle for Data**: All database operations through Drizzle
3. **Gradual Migration**: Replace existing queries one endpoint at a time
4. **Type Safety**: Leverage full TypeScript inference

## Benefits Over Direct Supabase Client

| Feature | Supabase Client | Drizzle ORM |
|---------|----------------|-------------|
| Type Safety | Basic | Full TypeScript inference |
| Query Builder | Limited | Full SQL capabilities |
| Relations | Manual joins | Automatic relation loading |
| Migrations | Manual SQL | Version controlled |
| Raw SQL | Not easily integrated | Seamless integration |

## File Structure

```
app/lib/database/
├── drizzle.ts          # Connection & exports
├── schema.ts           # Table definitions (existing)
├── types.ts            # TypeScript types (existing)
└── connection.ts       # Legacy (can be removed)

scripts/
├── seed.ts             # Supabase version (existing)
└── seed-drizzle.ts     # New Drizzle version

drizzle/
└── migrations/         # Generated by drizzle-kit
```

## Next Steps

1. Set up your `DATABASE_URL` in `.env`
2. Test the Drizzle connection: `npm run seed:drizzle`
3. Start migrating API endpoints to use Drizzle
4. Use `npm run db:studio` for database exploration

Your existing schema is already perfect for Drizzle! The main change is just switching from Supabase client queries to Drizzle queries while keeping Supabase for authentication.